<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ST5 | StrangerThings.space</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/itc-benguiat" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqEtbev8LIQXbs9y-SS1Wb4ETSAkne0NY",
            authDomain: "stranger-predictions.firebaseapp.com",
            projectId: "stranger-predictions",
            storageBucket: "stranger-predictions.firebasestorage.app",
            messagingSenderId: "132076207960",
            appId: "1:132076207960:web:b15f98fe8953b7106eaf2d",
            measurementId: "G-13XEZ9XJRK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DYNAMIC TARGET LOGIC ---
        function getTargetDate() {
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "America/New_York"}));
            const switchPoint = new Date("2025-12-26T08:00:00-05:00");
            
            if (now >= switchPoint) {
                // Countdown to New Years Eve 8pm EST
                return new Date("2025-12-31T20:00:00-05:00");
            }
            // Default Countdown to Christmas 8pm EST
            return new Date("2025-12-25T20:00:00-05:00");
        }

        const predictionQuestions = [
            { id: "el_lives", question: "Eleven: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "vecna_lives", question: "Vecna: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "will_lives", question: "Will Byers: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "dustin_lives", question: "Dustin: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "steve_lives", question: "Steve Harrington: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "mike_lives", question: "Mike Wheeler: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "max_lives", question: "Max Mayfield: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "nancy_lives", question: "Nancy Wheeler: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "john_lives", question: "Jonathan Byers: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "robin_lives", question: "Robin Buckley: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "erica_lives", question: "Erica Sinclair: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "murray_lives", question: "Murray: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "hopper_lives", question: "Hopper: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "joyce_lives", question: "Joyce: Lives or Dies?", options: ["Lives", "Dies"] },
            { id: "dim_x", question: "Is Dimension X real?", options: ["Yes", "No"] },
            { id: "henry_evil", question: "Is Henry Creel truly evil?", options: ["Yes", "No"] },
            { id: "wormholes", question: "Will wormholes appear?", options: ["Yes", "No"] },
            { id: "mind_ult", question: "Is Mind Flayer the final boss?", options: ["Yes", "No"] }
        ];

        // --- UI UTILS ---
        const isChristmas = () => {
            const now = new Date(new Date().toLocaleString("en-US", {timeZone: "America/New_York"}));
            return now.getMonth() === 11 && now.getDate() === 25;
        };

        // --- SEVEN SEGMENT RENDERER ---
        const digitMap = {
            '0': [1,1,1,1,1,1,0], '1': [0,1,1,0,0,0,0], '2': [1,1,0,1,1,0,1],
            '3': [1,1,1,1,0,0,1], '4': [0,1,1,0,0,1,1], '5': [1,0,1,1,0,1,1],
            '6': [1,0,1,1,1,1,1], '7': [1,1,1,0,0,0,0], '8': [1,1,1,1,1,1,1],
            '9': [1,1,1,1,0,1,1]
        };

        function drawSegment(id, value) {
            const container = document.getElementById(id);
            if (!container) return;
            const str = String(value).padStart(container.dataset.len || 2, '0');
            container.innerHTML = str.split('').map(digit => `
                <div class="segment-digit">
                    ${[0,1,2,3,4,5,6].map(i => `
                        <div class="seg seg-${i} ${digitMap[digit][i] ? 'on' : ''}"></div>
                    `).join('')}
                </div>
            `).join('');
        }

        function runCountdown() {
            const now = new Date();
            const diff = getTargetDate() - now;
            if (diff <= 0) return;

            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            drawSegment('seg-d', d);
            drawSegment('seg-h', h);
            drawSegment('seg-m', m);
            drawSegment('seg-s', s);
        }

        window.castVote = async (qid, idx) => {
            const docRef = doc(db, "votes", qid);
            try {
                const snap = await getDoc(docRef);
                if (!snap.exists()) await setDoc(docRef, { total: 0 });
                await updateDoc(docRef, { [`votes_${idx}`]: increment(1), total: increment(1) });
                localStorage.setItem(`voted_${qid}`, 'true');
                showResults(qid);
                updateGlobalCounter();
            } catch (e) { console.error(e); }
        };

        async function showResults(qid) {
            const optCont = document.getElementById(`opts-${qid}`);
            const resCont = document.getElementById(`res-${qid}`);
            if(!optCont || !resCont) return;
            optCont.classList.add('hidden');
            resCont.classList.remove('hidden');

            onSnapshot(doc(db, "votes", qid), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const total = data.total || 1;
                    const q = predictionQuestions.find(x => x.id === qid);
                    resCont.innerHTML = q.options.map((opt, i) => {
                        const count = data[`votes_${i}`] || 0;
                        const pct = Math.round((count / total) * 100);
                        return `
                            <div class="mb-2">
                                <div class="flex justify-between text-[10px] mb-1"><span>${opt}</span><span>${pct}%</span></div>
                                <div class="h-3 bg-zinc-800 rounded-sm overflow-hidden border border-zinc-700">
                                    <div class="bar-stripe h-full bg-red-600 transition-all duration-700" style="width: ${pct}%"></div>
                                </div>
                            </div>`;
                    }).join('');
                }
            });
        }

        async function updateGlobalCounter() {
            let grandTotal = 0;
            for (const q of predictionQuestions) {
                const snap = await getDoc(doc(db, "votes", q.id));
                if (snap.exists()) grandTotal += snap.data().total || 0;
            }
            drawSegment('total-votes', grandTotal);
        }

        window.toggleWorld = () => {
            document.body.classList.toggle('upside-down');
        };

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('intro-overlay').classList.add('finished');
                document.body.classList.add('intro-complete');
            }, 5500);

            if (isChristmas()) document.body.classList.add('christmas-mode');

            const container = document.getElementById('poll-grid');
            predictionQuestions.forEach(q => {
                const card = document.createElement('div');
                card.className = "poll-card p-4 glass-panel rounded-lg hover:border-red-600 transition-all";
                card.innerHTML = `
                    <h4 class="text-[11px] font-bold mb-3 tracking-widest text-zinc-400 uppercase">${q.question}</h4>
                    <div id="opts-${q.id}" class="grid grid-cols-2 gap-2">
                        ${q.options.map((opt, i) => `
                            <button onclick="castVote('${q.id}', ${i})" class="py-2 px-1 border border-zinc-700 hover:border-red-600 text-[10px] rounded uppercase">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    <div id="res-${q.id}" class="hidden"></div>
                `;
                container.appendChild(card);
                if (localStorage.getItem(`voted_${q.id}`)) showResults(q.id);
            });

            setInterval(runCountdown, 1000);
            updateGlobalCounter();
        };
    </script>

    <style>
        :root { --red: #ff0000; --glow: rgba(255, 0, 0, 0.6); --bg: #080808; }
        body { background: var(--bg); color: #fff; font-family: 'Roboto Mono', monospace; overflow-x: hidden; }
        .benguiat { font-family: 'ITC Benguiat', serif; }

        /* Intro Sequence */
        #intro-overlay {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            transition: transform 1.5s cubic-bezier(0.7, 0, 0.3, 1), opacity 1s;
        }
        #intro-overlay.finished {
            transform: translateY(-85vh) scale(0.2);
            opacity: 0; pointer-events: none;
        }

        .intro-text-wrap { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .intro-letter {
            position: absolute; color: var(--red); font-family: 'ITC Benguiat'; font-size: 8rem;
            text-transform: uppercase; opacity: 0; filter: blur(20px); text-shadow: 0 0 20px var(--red);
        }
        
        /* Individual letter paths */
        .l1 { animation: flyIn 5s forwards; transform: translate(-300%, -200%) scale(4); }
        .l2 { animation: flyIn 5s 0.2s forwards; transform: translate(300%, 200%) scale(4); }
        .l3 { animation: flyIn 5s 0.4s forwards; transform: translate(-400%, 0) scale(4); }
        .l4 { animation: flyIn 5s 0.6s forwards; transform: translate(0, -400%) scale(4); }
        .l5 { animation: flyIn 5s 0.8s forwards; transform: translate(400%, -100%) scale(4); }

        @keyframes flyIn {
            0% { opacity: 0; filter: blur(20px); }
            30% { opacity: 1; filter: blur(2px); }
            100% { opacity: 1; filter: blur(0); transform: translate(0,0) scale(1); }
        }

        /* 7-Segment UI */
        .segment-digit { position: relative; width: 24px; height: 42px; margin: 0 2px; }
        .seg { position: absolute; background: #220000; border-radius: 10px; box-shadow: 0 0 2px #000; transition: background 0.2s; }
        .seg.on { background: #ff1111; box-shadow: 0 0 10px #ff0000; }
        
        /* Segment positions */
        .seg-0 { top: 0; left: 4px; right: 4px; height: 4px; } /* top */
        .seg-1 { top: 4px; right: 0; bottom: 50%; width: 4px; margin-bottom: 2px; } /* top-right */
        .seg-2 { top: 50%; right: 0; bottom: 4px; width: 4px; margin-top: 2px; } /* bottom-right */
        .seg-3 { bottom: 0; left: 4px; right: 4px; height: 4px; } /* bottom */
        .seg-4 { top: 50%; left: 0; bottom: 4px; width: 4px; margin-top: 2px; } /* bottom-left */
        .seg-5 { top: 4px; left: 0; bottom: 50%; width: 4px; margin-bottom: 2px; } /* top-left */
        .seg-6 { top: calc(50% - 2px); left: 4px; right: 4px; height: 4px; } /* middle */

        /* VHS Overlay */
        .vhs-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            opacity: 0.6; animation: vhsJitter 0.2s infinite;
        }
        @keyframes vhsJitter {
            0% { transform: translate(0,0); }
            50% { transform: translate(1px, 0.5px); }
            100% { transform: translate(-0.5px, -1px); }
        }

        /* Upside Down */
        body.upside-down { filter: invert(1) hue-rotate(180deg) brightness(0.8); background: #eee; }

        /* General Styles */
        .glass-panel { background: rgba(20, 20, 20, 0.7); border: 1px solid rgba(255,255,255,0.05); }
        .bar-stripe {
            background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent);
            background-size: 15px 15px; animation: moveStripes 1s linear infinite;
        }
        @keyframes moveStripes { from { background-position: 0 0; } to { background-position: 30px 0; } }

        /* Christmas Lights */
        .light-string { display: flex; justify-content: center; gap: 1.5rem; padding: 10px; opacity: 0; }
        .christmas-mode .light-string { opacity: 1; }
        .light { width: 10px; height: 18px; border-radius: 50% 50% 40% 40%; animation: glow 1s infinite alternate; }
        @keyframes glow { from { filter: brightness(0.5) blur(1px); } to { filter: brightness(1.8) blur(3px); box-shadow: 0 0 10px currentColor; } }
    </style>
</head>
<body>

    <div class="vhs-overlay"></div>

    <!-- Intro -->
    <div id="intro-overlay">
        <div class="intro-text-wrap benguiat font-bold">
            <span class="intro-letter l1" style="left: 20%">S</span>
            <span class="intro-letter l2" style="left: 35%">T</span>
            <span class="intro-letter l3" style="left: 50%">R</span>
            <span class="intro-letter l4" style="left: 65%">A</span>
            <span class="intro-letter l5" style="left: 80%">5</span>
        </div>
    </div>

    <!-- Christmas Lights -->
    <div class="light-string">
        <div class="light bg-red-500" style="animation-delay: 0.1s"></div>
        <div class="light bg-yellow-400" style="animation-delay: 0.3s"></div>
        <div class="light bg-blue-500" style="animation-delay: 0.5s"></div>
        <div class="light bg-green-500" style="animation-delay: 0.2s"></div>
        <div class="light bg-purple-500" style="animation-delay: 0.4s"></div>
        <div class="light bg-red-500" style="animation-delay: 0.6s"></div>
    </div>

    <main class="max-w-6xl mx-auto px-6 py-8">
        
        <!-- Modern-80s Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-8">
            <div>
                <h1 class="benguiat text-5xl text-red-600 tracking-tighter leading-none glow-text">STRANGER<br>PREDICTIONS</h1>
                <p class="text-[9px] uppercase tracking-[0.4em] text-zinc-500 mt-3 font-bold">Terminal Interface v5.0.4</p>
            </div>

            <!-- 7 Segment Countdown -->
            <div class="flex gap-4 bg-black/40 p-4 rounded-xl border border-zinc-800">
                <div class="flex flex-col items-center">
                    <div id="seg-d" class="flex" data-len="2"></div>
                    <span class="text-[8px] text-zinc-600 mt-2 font-bold">DAYS</span>
                </div>
                <div class="text-red-900 self-center text-xl mt-[-10px]">:</div>
                <div class="flex flex-col items-center">
                    <div id="seg-h" class="flex" data-len="2"></div>
                    <span class="text-[8px] text-zinc-600 mt-2 font-bold">HOURS</span>
                </div>
                <div class="text-red-900 self-center text-xl mt-[-10px]">:</div>
                <div class="flex flex-col items-center">
                    <div id="seg-m" class="flex" data-len="2"></div>
                    <span class="text-[8px] text-zinc-600 mt-2 font-bold">MINS</span>
                </div>
            </div>

            <div class="flex flex-col items-end gap-3">
                <button onclick="toggleWorld()" class="px-5 py-2 border border-red-600 text-red-600 text-[9px] font-bold tracking-[0.2em] rounded-sm hover:bg-red-600 hover:text-black transition-all">
                    TOGGLE UPSIDE DOWN
                </button>
                <!-- Radio -->
                <div class="flex items-center gap-2 bg-zinc-900 px-3 py-1 rounded-full border border-zinc-800">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-[9px] text-zinc-400">RADIO: SYNTH_WAVE_FM</span>
                    <audio id="bg-audio" loop>
                        <source src="https://stream.nightride.fm/nightride.mp3" type="audio/mpeg">
                    </audio>
                    <button onclick="document.getElementById('bg-audio').paused ? document.getElementById('bg-audio').play() : document.getElementById('bg-audio').pause()" class="text-[10px] text-white ml-2">⏵/⏸</button>
                </div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
            <div class="glass-panel p-4 rounded-lg border-l-4 border-l-red-600 flex justify-between items-center">
                <span class="text-[10px] text-zinc-500 uppercase font-bold">Global Archive Entries</span>
                <div id="total-votes" class="flex" data-len="4"></div>
            </div>
            <div class="glass-panel p-4 rounded-lg flex justify-between items-center">
                <span class="text-[10px] text-zinc-500 uppercase font-bold">System Status</span>
                <span class="text-[10px] text-red-500 tracking-widest font-bold">STABLE // HAWKINS_NET</span>
            </div>
            <div class="glass-panel p-4 rounded-lg flex justify-between items-center">
                <span class="text-[10px] text-zinc-500 uppercase font-bold">Location</span>
                <span class="text-[10px] text-white">HAWKINS, INDIANA</span>
            </div>
        </div>

        <!-- Poll Grid -->
        <div id="poll-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

        <!-- Footer -->
        <footer class="mt-20 border-t border-zinc-900 pt-10 text-[9px] text-zinc-600 tracking-[0.3em] uppercase pb-12">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-center md:text-left">
                    <p>Unauthorized access is strictly prohibited</p>
                    <p class="mt-1">Fan made on <span class="text-red-800">strangerthings.space</span></p>
                </div>
                <div class="flex gap-6">
                    <a href="#" class="hover:text-red-600 transition-colors">Lab Protocols</a>
                    <a href="#" class="hover:text-red-600 transition-colors">Clearance Level 4</a>
                </div>
            </div>
        </footer>
    </main>

</body>
</html>
